{% extends 'partials/base.html.twig' %}

{% block content %}



    {% set use_captcha = grav.config.plugins.guestbook.use_captcha %}

    <h3>{{'PLUGIN_GUESTBOOK.ADD_MESSAGE'|t}}</h3>

    <script>
    $(function() {
        function validateEmail(email) {
            var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
            return re.test(email);
        }

        $(document).on('click tap', '.js__add-new-entry', function(event) {
            event.preventDefault();

            var text = $('.js__new-entry-text').val();
            var name = $('.js__new-entry-name').val();
            var email = $('.js__new-entry-email').val();
            var captcha = $('#g-recaptcha-response').val();

            if (text.length == 0 || email.length == 0 || name.length == 0) {
                $('.alert').html('Please fill all the fields');
                $('.alert-container').show();
                return;
            }

            if (!validateEmail(email)) {
                $('.alert').html('Please enter a valid email');
                $('.alert-container').show();
                return;
            }

            {% if use_captcha %}
            if (!captcha) {
                $('.alert').html("Error validating the security code");
                $('.alert-container').show();
                return;
            }
            {% endif %}

            $.ajax({
                url: "{{ grav.uri.rootUrl }}/add-guestbook-entry",
                data: {
                    text: $('.js__new-entry-text').val(),
                    name: $('.js__new-entry-name').val(),
                    email: $('.js__new-entry-email').val(),
                    lang: "{{ grav.language.getActive }}",
                    {% if use_captcha %}recaptchaResponse: captcha{% endif %}
                },
                type: 'POST'
            })
            .success(function() {
                $('.alert-container').hide();
                window.location.reload();
            })
            .error(function() {
                $('.alert').html("Error while posting the entry");
                $('.alert-container').show();
            });
        });
    });
    </script>

    {% if use_captcha %}
        <script src="https://www.google.com/recaptcha/api.js?onload=captchaOnloadCallback&render=explicit" async defer></script>

        <script>
            $(function() {
                var captchaOnloadCallback = function captchaOnloadCallback() {
                    grecaptcha.render('g-recaptcha', {
                        'sitekey': "{{grav.config.plugins.guestbook.recatpcha_site_key}}",
                        'callback': captchaValidatedCallback,
                        'expired-callback': captchaExpiredCallback
                    });
                }

                var captchaValidatedCallback = function captchaValidatedCallback() {
                };

                var captchaExpiredCallback = function captchaExpiredCallback() {
                    grecaptcha.reset();
                };
            });

            $(function() {
                var currentPage = 0;

                $(document).on('click tap', '.js__load-more', function(event) {
                   $.getJSON(window.location + '/page:' + (currentPage + 1))
                    .success(function(response) {
                        currentPage = parseInt(response.page);

                        response.comments.forEach(function(comment) {
                            $('.js__messages-container').append('<tr>' +
                                    '<td>' + message.text + '<br />{{'PLUGIN_COMMENTS.WRITTEN_ON'|t}} ' + message.date + ' {{'PLUGIN_COMMENTS.BY'|t}} ' + comment.author + '</td></tr>');
                        })

                        var totalRetrieved = response.totalRetrieved * (parseInt(response.page) + 1);

                        $('.totalRetrieved').html(totalRetrieved);
                        $('.totalAvailable').html(response.totalAvailable);

                        if (totalRetrieved == response.totalAvailable) {
                            $('.js__load-more').hide();
                        }
                    })
                    .error(function() {
                        alert('Unexpected error');
                    });
                });
            });
        </script>
    {% endif %}

    <div class="alert-container" style="display: none">
        <blockquote>
            <blockquote>
                <blockquote>
                    <blockquote>
                        <p class="alert"></p>
                    </blockquote>
                </blockquote>
            </blockquote>
        </blockquote>
    </div>

    <form>
        <textarea class="js__new-entry-text"></textarea>
        Name: <input type="text" class="js__new-entry-name" />
        Email: <input type="email" class="js__new-entry-email" />
        {% if use_captcha %}
            <div class="g-recaptcha" id="g-recaptcha"></div>
        {% endif %}

        <input type="submit" class="js__add-new-entry" />
    </form>

    {% if grav.twig.guestbookMessages|length %}

        <h3>{{'PLUGIN_GUESTBOOK.MESSAGES'|t}}</h3>

        <table class="js__messages-container">
            {% for message in grav.twig.guestbookMessages.messages %}
            <tr>
                <td>
                    {{message.text|e}}
                    <br />
                    {{'PLUGIN_COMMENTS.WRITTEN_ON'|t}} {{message.date|e}} {{'PLUGIN_COMMENTS.BY'|t}} {{message.author|e}}
                </td>
            </tr>
            {% endfor %}
        </table>

        {% if grav.twig.guestbookMessages.totalRetrieved < grav.twig.guestbookMessages.totalAvailable %}
            <button type="button" class="button center js__load-more">
                Load more
            </button>
        {% endif %}
    {% endif %}

{% endblock %}